<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>АИС Тест</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #151515;
            --card-bg-hover: #1f1f1f;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --divider: #2c2c2e;
            --accent-blue: #0a84ff;
            --accent-green: #30d158;
            --accent-red: #ff453a;
            --radius: 18px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --container-width: 900px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: var(--container-width);
            padding-bottom: 100px; /* Отступ под нижнюю панель кнопок */
            position: relative;
        }

        /* Typography */
        h1 {
            font-size: clamp(24px, 4vw, 32px); /* Адаптивный шрифт */
            margin: 20px 0 30px 0;
            text-align: center;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        h3 {
            font-size: 13px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin: 24px 0 12px 0;
            padding-left: 8px;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .view {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); scale: 0.98; }
            to { opacity: 1; transform: translateY(0); scale: 1; }
        }

        /* --- INPUTS --- */
        .input-wrapper {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 6px 16px;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        
        .input-wrapper:hover {
            background-color: var(--card-bg-hover);
        }

        .input-wrapper input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            width: 100%;
            padding: 12px 0;
            outline: none;
            font-family: inherit;
        }

        /* --- TOPIC GRID / LIST SYSTEM --- */
        
        /* Desktop Grid Style for Topics */
        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius); /* Rounded cards on desktop */
            color: var(--text-primary);
            font-size: 16px;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .list-item:hover {
            background-color: var(--card-bg-hover);
            transform: translateY(-2px);
        }
        
        .list-item:active {
            transform: scale(0.98);
        }

        .list-item.selected {
            background-color: #1c1c1e;
            border-color: var(--accent-blue);
        }

        .list-item.selected::after {
            content: '✓';
            color: var(--accent-blue);
            font-weight: bold;
            font-size: 18px;
            position: absolute;
            right: 16px;
        }

        .item-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 14px;
            font-size: 16px;
            flex-shrink: 0;
        }

        /* --- MOBILE ADAPTATION FOR LISTS --- */
        @media (max-width: 700px) {
            .topic-grid {
                display: flex;
                flex-direction: column;
                gap: 1px; /* Divider effect */
                background: var(--card-bg); /* Container bg */
                border-radius: var(--radius);
                overflow: hidden;
            }

            .list-item {
                border-radius: 0; /* No radius inside list */
                background: transparent; /* Inherit container */
                border: none;
                border-bottom: 1px solid var(--divider);
            }

            .list-item:last-child {
                border-bottom: none;
            }

            .list-item:hover {
                transform: none; /* No lift on mobile */
                background-color: var(--card-bg-hover);
            }
            
            .list-item.selected {
                background-color: #2c2c2e;
                border-color: transparent;
            }
        }

        /* --- BUTTONS --- */
        .action-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: var(--container-width);
            padding: 0 20px;
            z-index: 100;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius);
            border: none;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        @media (min-width: 701px) {
            /* On desktop, make buttons smaller width */
            .btn {
                max-width: 300px; 
            }
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn-primary {
            background-color: var(--text-primary);
            color: var(--bg-color);
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }

        /* --- QUIZ INTERFACE --- */
        .progress-container {
            background: var(--card-bg);
            padding: 16px;
            border-radius: var(--radius);
            margin-bottom: 24px;
        }
        
        .progress-meta {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .progress-bar {
            height: 8px;
            background: var(--divider);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-blue);
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .question-text {
            font-size: clamp(18px, 2.5vw, 24px);
            line-height: 1.5;
            font-weight: 700;
            margin-bottom: 32px;
            text-align: center;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* --- OPTIONS LAYOUT --- */
        .options-grid {
            display: grid;
            gap: 12px;
        }

        /* On very wide screens, make options 2 columns for better readability if text is short */
        /* But for quiz questions which can be long, 1 column is usually safer. keeping 1 col for now. */

        .option-item {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            font-size: 16px;
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .option-item:hover {
            background-color: var(--card-bg-hover);
            border-color: var(--divider);
        }

        .option-item.selected {
            background-color: #1c1c1e;
            border-color: var(--accent-blue);
        }
        
        .option-item input { display: none; }
        
        .indicator {
            width: 24px;
            height: 24px;
            border: 2px solid var(--text-secondary);
            margin-right: 16px;
            flex-shrink: 0;
            margin-top: 0; /* Align top */
            position: relative;
            transition: all 0.2s;
        }
        
        .radio-indicator { border-radius: 50%; }
        .checkbox-indicator { border-radius: 6px; }

        .option-item.selected .indicator {
            border-color: var(--accent-blue);
            background: var(--accent-blue);
        }

        .option-item.selected .indicator::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50%; height: 50%;
            background: white;
            border-radius: inherit;
        }
        .option-item.selected .checkbox-indicator::after {
             background: transparent;
             border: 2px solid white;
             border-top: none;
             border-right: none;
             width: 10px; height: 5px;
             transform: translate(-50%, -60%) rotate(-45deg);
             border-radius: 0;
        }

        /* --- DRAG & DROP & MATCHING --- */
        .matching-row {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            display: grid;
            gap: 10px;
        }
        
        @media (min-width: 700px) {
            .matching-row {
                grid-template-columns: 1fr 1fr;
                align-items: center;
                gap: 20px;
            }
        }

        select {
            width: 100%;
            background: #2c2c2e;
            color: white;
            border: 1px solid transparent;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 16px;
            appearance: none;
            cursor: pointer;
        }
        select:hover { border-color: var(--text-secondary); }

        .sortable-item {
            background: var(--card-bg);
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            cursor: grab;
            transition: background 0.2s;
        }
        .sortable-item:hover { background: var(--card-bg-hover); }
        .sortable-item:active { cursor: grabbing; }
        
        .drag-handle {
            color: var(--text-secondary);
            margin-right: 16px;
            font-size: 24px;
            line-height: 1;
        }

        /* --- FEEDBACK POPUP --- */
        .feedback-popup {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            padding: 12px 24px;
            border-radius: 30px;
            z-index: 200;
            text-align: center;
            font-weight: 600;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            min-width: 200px;
        }
        
        .feedback-popup.visible {
            transform: translateX(-50%) translateY(0);
        }

        .feedback-success {
            background: rgba(48, 209, 88, 0.15);
            color: #30d158;
            border: 1px solid rgba(48, 209, 88, 0.2);
        }

        .feedback-error {
            background: rgba(255, 69, 58, 0.15);
            color: #ff453a;
            border: 1px solid rgba(255, 69, 58, 0.2);
        }
        
        .detailed-feedback {
            margin-top: 20px;
            background: #1c1c1e;
            border: 1px solid #2c2c2e;
            padding: 20px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        /* --- RESULTS --- */
        .result-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .result-circle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 8px solid var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 800;
            margin: 0 auto 24px auto;
        }
        
        .result-good { border-color: var(--accent-green); color: var(--accent-green); box-shadow: 0 0 20px rgba(48, 209, 88, 0.2); }
        .result-avg { border-color: #ff9f0a; color: #ff9f0a; box-shadow: 0 0 20px rgba(255, 159, 10, 0.2); }
        .result-bad { border-color: var(--accent-red); color: var(--accent-red); box-shadow: 0 0 20px rgba(255, 69, 58, 0.2); }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1px;
            background: var(--divider);
            border-radius: 16px;
            overflow: hidden;
            width: 100%;
            border: 1px solid var(--divider);
        }
        
        @media (min-width: 700px) {
            .stat-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                background: transparent;
                border: none;
            }
            .stat-row {
                background: var(--card-bg) !important;
                border-radius: 12px;
                border: 1px solid transparent;
            }
            .stat-row:hover {
                border-color: var(--divider);
            }
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--card-bg);
            align-items: center;
        }

    </style>
</head>
<body>

<div id="feedback-popup" class="feedback-popup"></div>

<div class="app-container">
    
    <div id="start-screen" class="view active">
        <h1>Тестирование АИС</h1>
        
        <h3>Настройки</h3>
        <div class="input-wrapper">
            <input type="number" id="question-count" placeholder="Количество вопросов (0 = все)" min="0">
        </div>

        <h3>Разделы тестирования</h3>
        
        <div class="topic-grid" style="margin-bottom: 12px;">
            <div class="list-item" id="select-all-btn">
                <div style="display:flex; align-items:center;">
                    <div class="item-icon" style="background: var(--accent-blue); color: #fff;">⚡</div>
                    <span>Выбрать все темы</span>
                </div>
            </div>
        </div>

        <div class="topic-grid" id="topic-list">
            </div>

        <div class="action-bar">
            <button class="btn btn-primary" id="start-btn">Начать тест</button>
        </div>
    </div>

    <div id="quiz-screen" class="view">
        <div class="progress-container">
            <div class="progress-meta">
                <span id="question-topic">Тема</span>
                <span id="question-counter">0 / 0</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>

        <div class="question-text" id="question-text">
            Загрузка...
        </div>

        <div id="options-container" class="options-grid">
            </div>

        <div id="detailed-feedback" class="detailed-feedback"></div>

        <div class="action-bar">
            <button class="btn btn-primary" id="submit-btn">Ответить</button>
            <button class="btn btn-primary" id="next-btn" style="display: none;">Следующий вопрос</button>
        </div>
    </div>

    <div id="result-screen" class="view">
        <h1>Результаты</h1>
        
        <div class="result-layout">
            <div id="result-circle" class="result-circle">0%</div>
            <p id="final-message" style="text-align:center; color: var(--text-secondary); margin-bottom:30px; font-size: 18px;"></p>
        </div>

        <h3>Статистика по темам</h3>
        <div class="stat-grid" id="topic-stats-container">
            </div>

        <div class="action-bar">
            <button class="btn btn-primary" onclick="location.reload()">Завершить тест</button>
        </div>
    </div>

</div>

<script>
    // --- DATA ---
    const QuestionType = { SingleChoice: 0, MultipleChoice: 1, Sequence: 2, Matching: 3 };

    const rawQuestions = [
        { id: 1, topic: "Архитектурные стили", type: QuestionType.SingleChoice, text: "Системы, на вход которых поступает сырье, а на выходе образуется готовый продукт, называются:", options: ["Системы управления доступом", "Системы мониторинга ресурсов", "Системы управления производством", "Управляющие системы"], correct: "3" },
        { id: 2, topic: "Архитектурные стили", type: QuestionType.SingleChoice, text: "К какому архитектурному стилю относится экспертная система «Expro»?", options: ["Потоки данных", "Виртуальная машина", "Независимые компоненты", "Централизованные данные"], correct: "2" },
        { id: 4, topic: "Архитектурные стили", type: QuestionType.MultipleChoice, text: "К архитектурному стилю «Виртуальные машины» относятся следующие архитектурные подстили:", options: ["Клиент-серверные системы", "Интерпретаторы", "Системы взаимодействующих процессов", "Системы, основанные на правилах"], correct: "2,4" },
        { id: 8, topic: "Архитектурные стили", type: QuestionType.SingleChoice, text: "В каком архитектурном стиле используется механизм «Публикация-подписка»?", options: ["Вызов с возвратом", "Потоки данных", "Централизованные репозитарии", "Независимые компоненты"], correct: "4" },
        { id: 20, topic: "Архитектурные стили", type: QuestionType.SingleChoice, text: "К какому архитектурному стилю относится система «Blackboard»?", options: ["Потоки данных", "Виртуальная машина", "Централизованные данные", "Независимые компоненты"], correct: "3" },
        { id: 28, topic: "Архитектурные стили", type: QuestionType.MultipleChoice, text: "К архитектурному стилю «Вызов с возвратом» относятся следующие архитектурные подстили:", options: ["Клиент-серверные системы", "Системы, управляемые событиями", "Объектно-ориентированные системы", "Иерархические многоуровневые системы"], correct: "1,3,4" },
        { id: 39, topic: "Архитектурные стили", type: QuestionType.MultipleChoice, text: "К архитектурному стилю «Независимые компоненты» относятся следующие архитектурные подстили:", options: ["Системы, управляемые событиями", "Системы взаимодействующих процессов", "Объектно-ориентированные системы", "Клиент-серверные системы"], correct: "1,2" },
        { id: 52, topic: "Архитектурные стили", type: QuestionType.MultipleChoice, text: "К архитектурному стилю «потоки данных» относятся следующие архитектурные подстили:", options: ["Системы пакетно-последовательной обработки", "Системы, основанные на правилах", "Системы типа конвейеры и фильтры", "Системы взаимодействующих процессов"], correct: "1,3" },
        { id: 53, topic: "Архитектурные стили", type: QuestionType.MultipleChoice, text: "К архитектурному стилю «Централизованные репозитарии данных» относятся следующие архитектурные подстили:", options: ["Системы, основанные на использовании централизованной базы данных", "Системы, управляемые событиями", "Системы, использующие принцип классной доски", "Интерпретаторы"], correct: "1,3" },
        { id: 57, topic: "Архитектурные стили", type: QuestionType.SingleChoice, text: "Какой архитектурный стиль лучше всего применять при построении систем цифровой обработки изображений?", options: ["Виртуальная машина", "Потоки данных", "Независимые компоненты", "Вызов с возвратом"], correct: "2" },
        { id: 3, topic: "Фреймворки", type: QuestionType.SingleChoice, text: "Набор типовых решений, методик проектирования и классов, которые могут быть использованы при решении множества задач, называется:", options: ["Антипаттерн", "Архитектурный стиль", "Фреймворк", "Компонентная среда"], correct: "3" },
        { id: 5, topic: "Фреймворки", type: QuestionType.SingleChoice, text: "Недостатками какого фреймворка являются невозможность описать динамику системы и отсутствие распространения изменений между элементами:", options: ["TOGAF", "Фреймворк Захмана", "DoDAF", "RUP"], correct: "2" },
        { id: 6, topic: "Фреймворки", type: QuestionType.SingleChoice, text: "Какой из фреймворков описывается в виде круговой последовательности фаз проектирования системы?", options: ["Фреймворк Захмана", "Фреймворк TOGAF", "Фреймворк DoDAF", "ITIL"], correct: "2" },
        { id: 9, topic: "Фреймворки", type: QuestionType.Sequence, text: "Расположите фазы фреймворка TOGAF в правильном порядке:", options: ["Разработка общего представления", "Разработка бизнес-архитектуры", "Разработка информационной архитектуры", "Разработка технологической архитектуры"], correct: "1234" },
        { id: 21, topic: "Фреймворки", type: QuestionType.SingleChoice, text: "Какой из перечисленных фреймворков имеет матричное представление?", options: ["TOGAF", "Фреймворк Захмана", "DoDAF", "ITIL"], correct: "2" },
        { id: 26, topic: "Фреймворки", type: QuestionType.SingleChoice, text: "В каком государственном стандарте закреплен стандарт разработки информационной системы?", options: ["ГОСТ 34.xxx", "ГОСТ 28195", "ГОСТ Р ИСО 9001", "ГОСТ 19.xxx"], correct: "2" },
        { id: 47, topic: "Фреймворки", type: QuestionType.Sequence, text: "Расположите в правильном порядке слои архитектуры информационной системы:", options: ["Бизнес-архитектура", "ИТ-архитектура", "Архитектура данных", "Архитектура приложения", "Техническая архитектура"], correct: "12345" },
        { id: 65, topic: "Фреймворки", type: QuestionType.Sequence, text: "Расположите шаги методики построения архитектурного описания согласно фреймворку DoDAF в правильном порядке:", options: ["определение назначения архитектурного стиля", "определение уровня детализации описания", "определение необходимых данных", "сбор и обработка данных", "анализ архитектуры на соответствие требованиям", "документирование архитектуры"], correct: "123456" },
        { id: 74, topic: "Фреймворки", type: QuestionType.SingleChoice, text: "Какой из перечисленных фреймворков осуществляет построение точек зрения?", options: ["Фреймворк Захмана", "Фреймворк TOGAF", "Фреймворк DoDAF", "RUP"], correct: "3" },
        { id: 75, topic: "Фреймворки", type: QuestionType.Matching, text: "Установите соответствие понятий фреймворка DoDAF:", matchingOptions: { "1": "Фреймворк", "2": "Модель", "3": "Вид", "4": "Точка зрения" }, matchingValues: { "А": "Набор типовых решений, методик проектирования и классов", "Б": "Шаблон сбора данных", "В": "Способ представления связного набора данных", "Г": "Описание данных с позиции их полезности для принятия решения" }, correct: "1-А,2-Б,3-В,4-Г" },
        { id: 7, topic: "Паттерны", type: QuestionType.SingleChoice, text: "Какой группе паттернов относятся паттерны «Однопоточное выполнение», «Охраняемая приостановка», «Объект блокировки»?", options: ["Структурные паттерны", "Поведенческие паттерны", "Производящие паттерны", "Паттерны параллельного программирования"], correct: "4" },
        { id: 12, topic: "Паттерны", type: QuestionType.SingleChoice, text: "Какие паттерны рассматривают архитектуру информационной системы в целом?", options: ["Системные паттерны", "Концептуальные паттерны", "Структурные паттерны", "Архитектурные паттерны"], correct: "2" },
        { id: 18, topic: "Паттерны", type: QuestionType.SingleChoice, text: "Набор абстрактных классов наиболее часто внедряемых плохих решений проблем, называется:", options: ["Фреймворк", "Паттерн", "Антипаттерн", "Шаблон"], correct: "3" },
        { id: 27, topic: "Паттерны", type: QuestionType.SingleChoice, text: "К какой группе паттернов относятся паттерны «Итератор», «Моментальный снимок», «Состояние»?", options: ["Структурные паттерны", "Поведенческие паттерны", "Порождающие паттерны", "Системные паттерны"], correct: "2" },
        { id: 36, topic: "Паттерны", type: QuestionType.SingleChoice, text: "К какой группе паттернов относятся паттерны «Мост», «Адаптер», «Прокси»?", options: ["Структурные паттерны", "Поведенческие паттерны", "Порождающие паттерны", "Концептуальные паттерны"], correct: "1" },
        { id: 48, topic: "Паттерны", type: QuestionType.SingleChoice, text: "К какой группе относится паттерн «Фабрика»?", options: ["Структурные паттерны", "Поведенческие паттерны", "Производящие паттерны", "Системные паттерны"], correct: "3" },
        { id: 54, topic: "Паттерны", type: QuestionType.SingleChoice, text: "К какой группе паттернов относятся паттерны «Транзакция», «Сессия», «Обратный вызов»?", options: ["Поведенческие паттерны", "Порождающие паттерны", "Концептуальные паттерны", "Системные паттерны"], correct: "4" },
        { id: 59, topic: "Паттерны", type: QuestionType.SingleChoice, text: "Набор абстрактных классов, ориентированных на решение задач, относящихся к определенному домену, называется:", options: ["Фреймворк", "Антипаттерн", "Паттерн", "Методология"], correct: "3" },
        { id: 10, topic: "Компонентные технологии", type: QuestionType.SingleChoice, text: "Структурная единица программной системы с четко определенным интерфейсом, который полностью описывает ее зависимости от контекста, называется:", options: ["Класс", "Объект", "Компонент", "Модуль"], correct: "3" },
        { id: 17, topic: "Компонентные технологии", type: QuestionType.SingleChoice, text: "Как называется расширение объектной модели компонентов COM, которые позволяют создавать удаленные объекты и обеспечивать доступ к ним?", options: ["COM+", "DCOM", ".NET", "CORBA"], correct: "2" },
        { id: 19, topic: "Компонентные технологии", type: QuestionType.SingleChoice, text: "Как называется основная библиотека классов, образующая .Net Framework?", options: ["CLR", "FCL", "BCL", "API"], correct: "2" },
        { id: 25, topic: "Компонентные технологии", type: QuestionType.Matching, text: "Установите соответствие определений элементов сборки .Net Framework:", matchingOptions: { "1": "Код приложения", "2": "Метаданные", "3": "Манифест", "4": "Ресурсы" }, matchingValues: { "А": "Текст, который компилируется в формат промежуточного языка", "Б": "Информация о типах, объявленных в сборке", "В": "Сведения об имени сборки, версии, файлах", "Г": "Графические файлы, курсоры и статический текст" }, correct: "1-А,2-Б,3-В,4-Г" },
        { id: 30, topic: "Компонентные технологии", type: QuestionType.SingleChoice, text: "Как называется способ повторного использования COM-объектов, при котором внешний объект представляет в качестве собственных интерфейсы, которые на самом деле реализуются внутренним объектом?", options: ["Наследование", "Агрегирование", "Инкапсуляция", "Полиморфизм"], correct: "2" },
        { id: 31, topic: "Компонентные технологии", type: QuestionType.SingleChoice, text: "Как называется COM-объект, который имеет собственные перманентные данные, в составе которых все, что необходимо для запуска и инициализации одного экземпляра объекта?", options: ["Делегат", "Прокси", "Моникер", "Заглушка"], correct: "3" },
        { id: 32, topic: "Компонентные технологии", type: QuestionType.Sequence, text: "Расположите в правильном порядке действия по созданию объекта COM:", options: ["Вызов CoCreateInstance", "Нахождение записи о классе объекта", "Запуск сервера и возвращение указателя", "Вызов требуемого метода"], correct: "1234" },
        { id: 33, topic: "Компонентные технологии", type: QuestionType.SingleChoice, text: "Как называется универсальный промежуточный язык, используемый в технологии .Net Framework?", options: ["CLR", "CIL", "JIT", "MSIL"], correct: "2" },
        { id: 50, topic: "Компонентные технологии", type: QuestionType.SingleChoice, text: "Набор базовых, необходимых для функционирования большинства компонентов служб, вместе с поддерживаемой с их помощью компонентной моделью, называется:", options: ["Фреймворк", "Платформа", "Компонентная среда", "Архитектура"], correct: "3" },
        { id: 55, topic: "Компонентные технологии", type: QuestionType.MultipleChoice, text: "К квазикомпонентным технологиям относят:", options: ["Сокеты", "Системы распределенных объектов", "Вызов удаленных процедур", "Сервисно-ориентированные системы"], correct: "1,2,3,4" },
        { id: 56, topic: "Компонентные технологии", type: QuestionType.SingleChoice, text: "Как называется способ повторного использования COM-объектов, при котором внешний объект использует внутренний объект в качестве сервера, при этом к методам внутреннего объекта обращаться может только внешний объект?", options: ["Агрегирование", "Включение", "Наследование", "Делегирование"], correct: "2" },
        { id: 71, topic: "Компонентные технологии", type: QuestionType.SingleChoice, text: "Как называется расширение объектной модели компонентов COM, в основе которой лежат механизм работы с транзакциями, событиями и очередями сообщений?", options: ["DCOM", "COM+", ".NET Remoting", "CORBA"], correct: "2" },
        { id: 73, topic: "Компонентные технологии", type: QuestionType.MultipleChoice, text: "Основными составными частями .NET Framework являются:", options: ["Библиотека классов (FCL)", "JVM", "Среда исполнения (CLR)", "COM+"], correct: "1,3" },
        { id: 11, topic: "Веб-сервисы", type: QuestionType.MultipleChoice, text: "Назовите протоколы, определяющие механизмы обнаружения Web-сервисов:", options: ["SOAP", "UDDI", "WSDL", "ebXML"], correct: "2,4" },
        { id: 14, topic: "Веб-сервисы", type: QuestionType.SingleChoice, text: "Язык, который позволяет описывать бизнес-процесс в терминах некоторой последовательности обращения к Web-сервисам, называется:", options: ["WSDL", "BPEL", "SOAP", "UDDI"], correct: "2" },
        { id: 35, topic: "Веб-сервисы", type: QuestionType.SingleChoice, text: "Укажите название языка описания веб-служб:", options: ["UDDI", "SOAP", "WSDL", "BPEL"], correct: "3" },
        { id: 37, topic: "Веб-сервисы", type: QuestionType.MultipleChoice, text: "Назовите протоколы, определяющие форматы сообщений и способ обмена сообщениями:", options: ["SOAP", "HTTP", "XML-RPC", "JMS"], correct: "1,3" },
        { id: 40, topic: "Веб-сервисы", type: QuestionType.SingleChoice, text: "Выберите правильное трактование ответа на запрос XML-RPC:\n<methodResponse><params><param><value>boat</value></params></methodResponse>", options: ["Ответ с двумя параметрами", "Ответ с одним параметром, значение параметра: boat", "Ошибка формата", "Запрос на вызов метода"], correct: "2" },
        { id: 44, topic: "Веб-сервисы", type: QuestionType.Matching, text: "Установите соответствие для справочника реестра UDDI:", matchingOptions: { "1": "Справочник «зеленых страниц»", "2": "Справочник «белых страниц»", "3": "Справочник «желтых страниц»" }, matchingValues: { "А": "Содержит способы доступа к сервисам", "Б": "Содержит базовую информацию о бизнесе", "В": "Содержит бизнес-информацию, классифицированную по типу бизнеса" }, correct: "1-А,2-Б,3-В" },
        { id: 45, topic: "Веб-сервисы", type: QuestionType.SingleChoice, text: "Выберите правильное трактование ответа на запрос SOAP (содержит параметр TranslateResult со значением boat):", options: ["Ответ без параметров", "Параметр с именем TranslateResult имеет значение boat", "Ошибка в формате SOAP", "Запрос на перевод слова"], correct: "2" },
        { id: 46, topic: "Веб-сервисы", type: QuestionType.SingleChoice, text: "Выберите правильное трактование запроса SOAP (вызывается метод Translate с параметром 'лодка'):", options: ["Вызывается метод Translate с одним параметром, значение параметра: лодка", "Вызывается метод Translate без параметров", "Это ответ на запрос Translate", "Ошибка в формате XML"], correct: "1" },
        { id: 49, topic: "Веб-сервисы", type: QuestionType.MultipleChoice, text: "Назовите недостатки протокола XML-RPC:", options: ["Избыточность XML", "Не поддерживают работу с объектами", "Отсутствуют пространства имен", "Слишком сложный синтаксис"], correct: "1,2,3" },
        { id: 60, topic: "Веб-сервисы", type: QuestionType.MultipleChoice, text: "Назовите транспортные протоколы, отвечающие за транспортировку сообщений:", options: ["HTTP", "SOAP", "JMS", "FTP", "SMTP", "WSDL"], correct: "1,3,4,5" },
        { id: 63, topic: "Веб-сервисы", type: QuestionType.Sequence, text: "Расположите протоколы для работы с веб-сервисами в правильном порядке, начиная с высокого уровня:\n1. UDDI, ebXML\n2. WSDL\n3. SOAP, XML-RPC\n4. HTTP, JMS, FTP, SMTP", options: ["UDDI, ebXML", "WSDL", "SOAP, XML-RPC", "HTTP, JMS, FTP, SMTP"], correct: "1234" },
        { id: 64, topic: "Веб-сервисы", type: QuestionType.Sequence, text: "Расположите шаги вызова удаленной процедуры RPC в правильном порядке:", options: ["Клиент выполняет локальный вызов процедуры", "Серверная заглушка выполняет требуемую процедуру", "Результаты передаются клиентской заглушке", "Клиентская заглушка передает результат программе"], correct: "1234" },
        { id: 66, topic: "Веб-сервисы", type: QuestionType.Sequence, text: "Расставьте правильно шаги алгоритма создания соглашения о сотрудничестве в реестре ebXML:", options: ["Сторона, оказывающая услуги, регистрирует заявление", "Сторона, заинтересованная в услуге, находит заявление", "Создается проект соглашения", "Стороны достигают соглашения"], correct: "1234" },
        { id: 67, topic: "Веб-сервисы", type: QuestionType.Matching, text: "Установите соответствие тегов WSDL:", matchingOptions: { "1": "binding", "2": "portType", "3": "message", "4": "service" }, matchingValues: { "А": "Формат пересылки и протоколы", "Б": "Указание порта сервиса", "В": "Сообщения в терминах «запрос-ответ»", "Г": "Местонахождение сервиса" }, correct: "1-А,2-Б,3-В,4-Г" },
        { id: 68, topic: "Веб-сервисы", type: QuestionType.Matching, text: "Установите соответствие функций API UDDI:", matchingOptions: { "1": "Get_xxx функции", "2": "Find_xxx функции", "3": "Delete_xxx функции", "4": "Save_xxx функции" }, matchingValues: { "А": "Функции для получения информации о сервисах", "Б": "Функции для поиска сервисов", "В": "Функции для удаления сервисов", "Г": "Функции для регистрации и изменения сервисов" }, correct: "1-А,2-Б,3-В,4-Г" },
        { id: 72, topic: "Веб-сервисы", type: QuestionType.SingleChoice, text: "Выберите правильное трактование ответа на запрос XML-RPC:\n<methodResponse><params><param><value>boat</value></param></params></methodResponse>", options: ["Ответ с одним параметром, значение: boat", "Ответ с двумя параметрами", "Ошибка в формате XML", "Пустой ответ"], correct: "1" },
        { id: 13, topic: "Безопасность", type: QuestionType.SingleChoice, text: "Механизм управления доступом, при использовании которого для каждого субъекта необходимо перечислить все объекты, к которым он имеет доступ, называется:", options: ["Мандатное управление", "Прямое управление", "Ролевое управление", "Атрибутное управление"], correct: "2" },
        { id: 34, topic: "Безопасность", type: QuestionType.SingleChoice, text: "Механизм управления доступ, при использовании которого права доступа определяются ролям:", options: ["Прямое управление", "Мандатное управление", "Ролевое управление", "Атрибутное управление"], correct: "3" },
        { id: 43, topic: "Безопасность", type: QuestionType.SingleChoice, text: "Механизм управления доступом, при использовании которого все объекты и субъекты относятся к определенному уровню, на котором им разрешено работать, называется:", options: ["Прямое управление", "Мандатное управление", "Ролевое управление", "Атрибутное управление"], correct: "2" },
        { id: 15, topic: "Классификация систем", type: QuestionType.MultipleChoice, text: "Что включает в себя информационная система?", options: ["Программное обеспечение", "Вычислительное оборудование", "Системный персонал", "Лингвистические средства", "Информационные ресурсы"], correct: "1,2,3,4,5" },
        { id: 22, topic: "Классификация систем", type: QuestionType.Sequence, text: "Расположите шаги RMI-запроса в правильной последовательности:", options: ["Удаленный объект создается на сервере", "Клиент обращается к RMI-реестру", "Реестр отыскивает заместителя объекта", "Клиент вызывает метод у заместителя"], correct: "1234" },
        { id: 23, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "Какой методологии разработки программного обеспечения не существует?", options: ["Waterfall", "Scrum", "RUP", "Управление персоналом"], correct: "4" },
        { id: 24, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "Системы, назначением которых является измерение некоторых параметров и выдача управляющих воздействий, называются:", options: ["Системы управления доступом", "Системы мониторинга ресурсов", "Управляющие системы", "Системы управления производством"], correct: "3" },
        { id: 29, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "Порталы, предоставляющие бизнес-услуги потребителям и компаниям, называют:", options: ["Корпоративные", "Публичные", "Вертикальные", "Горизонтальные"], correct: "1" },
        { id: 38, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "Web-приложение, которое предоставляет пользователю доступ к различным сервисам, называется:", options: ["Портал", "Сайт", "Приложение", "Сервис"], correct: "1" },
        { id: 41, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "ИТ-системы, обеспечивающие выдачу консолидированных данных для поддержки принятия решений, называются:", options: ["Информационно-управляющие системы", "Системы управления доступом", "Системы мониторинга", "Управляющие системы"], correct: "1" },
        { id: 42, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "Системы, назначением которых является отслеживание состояния сущности с момента поступления до момента выхода из системы, называются:", options: ["Системы управления производством", "Системы мониторинга и управления ресурсами", "Управляющие системы", "Информационно-управляющие системы"], correct: "2" },
        { id: 51, topic: "Классификация систем", type: QuestionType.Matching, text: "Установите соответствие типов рисков:", matchingOptions: { "1": "Проектный риск", "2": "Бизнес-риск", "3": "Операционный риск", "4": "Технический риск" }, matchingValues: { "А": "Неподходящая технология для реализации", "Б": "Потеря покупателя из-за недовольства", "В": "Невозможность выполнить операцию", "Г": "Перегрузка сервера запросами" }, correct: "1-А,2-Б,3-В,4-Г" },
        { id: 58, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "Какой федеральный закон Российской Федерации дает определение информационной системы?", options: ["№149-ФЗ", "№152-ФЗ", "№161-ФЗ", "№187-ФЗ"], correct: "1" },
        { id: 61, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "Небольшие приложения портала, разработка и просмотр которого осуществляется независимо от других, называется:", options: ["Виджет", "Портлет", "Модуль", "Компонент"], correct: "2" },
        { id: 62, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "Определенная структура памяти, содержащая массив указателей на функции, называется:", options: ["Интерфейс", "Класс", "Объект", "Метод"], correct: "1" },
        { id: 69, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "Архитектура, при которой клиент реализует только логику представления, называется:", options: ["Двухуровневая архитектура", "Трехуровневая архитектура", "Многоуровневая архитектура", "Микросервисная архитектура"], correct: "2" },
        { id: 70, topic: "Классификация систем", type: QuestionType.SingleChoice, text: "Системы, назначением которых является обеспечение доступа субъектов к объектам с использованием политик и ролей, называются:", options: ["Системы управления производством", "Системы управления доступом", "Системы мониторинга", "Управляющие системы"], correct: "2" },
        { id: 16, topic: "Методологии", type: QuestionType.Matching, text: "Установите соответствие:", matchingOptions: { "1": "Архитектурный стиль", "2": "Разработка документации", "3": "Управление требованиями", "4": "Управление качеством" }, matchingValues: { "А": "Создание легко адаптируемых фреймворков", "Б": "Получение детального описания системы", "В": "Разработка системы с наибольшим набором функций", "Г": "Обеспечение высокой отказоустойчивости" }, correct: "1-А,2-Б,3-В,4-Г" }
    ];

    const topicColors = {
        "Архитектурные стили": "#ff453a",
        "Фреймворки": "#ff9f0a",
        "Паттерны": "#ffd60a",
        "Компонентные технологии": "#30d158",
        "Веб-сервисы": "#64d2ff",
        "Безопасность": "#0a84ff",
        "Классификация систем": "#5e5ce6",
        "Методологии": "#bf5af2"
    };

    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let userAnswers = [];

    // --- LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        initStartScreen();
        setupEventListeners();
    });

    function initStartScreen() {
        const topics = [...new Set(rawQuestions.map(q => q.topic))];
        const topicList = document.getElementById('topic-list');
        topicList.innerHTML = '';
        
        topics.forEach(topic => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.dataset.topic = topic;
            
            const color = topicColors[topic] || "#8e8e93";
            const firstLetter = topic.charAt(0);

            div.innerHTML = `
                <div style="display:flex; align-items:center; width:100%;">
                    <div class="item-icon" style="background: ${color}; color: #000; font-weight:700;">${firstLetter}</div>
                    <span class="topic-text">${topic}</span>
                </div>
            `;
            
            div.onclick = () => div.classList.toggle('selected');
            topicList.appendChild(div);
        });
    }

    function setupEventListeners() {
        document.getElementById('select-all-btn').onclick = () => {
            const items = document.querySelectorAll('#topic-list .list-item');
            const allSelected = Array.from(items).every(i => i.classList.contains('selected'));
            items.forEach(i => allSelected ? i.classList.remove('selected') : i.classList.add('selected'));
        };

        document.getElementById('start-btn').onclick = startTest;
        document.getElementById('submit-btn').onclick = submitAnswer;
        document.getElementById('next-btn').onclick = nextQuestion;
    }

    function startTest() {
        const selectedTopicEls = document.querySelectorAll('#topic-list .list-item.selected');
        const selectedTopics = Array.from(selectedTopicEls).map(el => el.dataset.topic);

        if (selectedTopics.length === 0) {
            showFeedback('Выберите хотя бы один раздел', false);
            return;
        }

        let filtered = rawQuestions.filter(q => selectedTopics.includes(q.topic));
        filtered.sort(() => Math.random() - 0.5);

        const countInput = document.getElementById('question-count');
        const count = parseInt(countInput.value) || 0;
        if (count > 0 && count < filtered.length) {
            filtered = filtered.slice(0, count);
        }

        currentQuestions = filtered.map(q => prepareQuestion(q));

        if (currentQuestions.length === 0) {
            showFeedback('Нет вопросов по выбранным темам', false);
            return;
        }

        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];

        switchView('quiz-screen');
        renderQuestion();
    }

    function prepareQuestion(original) {
        const q = JSON.parse(JSON.stringify(original));
        
        if (q.type === QuestionType.SingleChoice || q.type === QuestionType.MultipleChoice) {
            let indexedOptions = q.options.map((opt, idx) => ({ idx: idx + 1, text: opt }));
            indexedOptions.sort(() => Math.random() - 0.5);
            q.options = indexedOptions.map(o => o.text);
            
            const correctIndices = q.correct.split(',').map(s => parseInt(s.trim()));
            const newCorrectIndices = correctIndices.map(oldIdx => {
                return indexedOptions.findIndex(o => o.idx === oldIdx) + 1;
            }).sort((a,b) => a-b);
            
            q.correct = newCorrectIndices.join(',');
        }
        else if (q.type === QuestionType.Sequence) {
             let indexedOptions = q.options.map((opt, idx) => ({ idx: idx + 1, text: opt }));
             indexedOptions.sort(() => Math.random() - 0.5);
             q.options = indexedOptions.map(o => o.text);
        }
        return q;
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }

    function renderQuestion() {
        const q = currentQuestions[currentQuestionIndex];
        
        document.getElementById('question-topic').textContent = q.topic;
        document.getElementById('question-counter').textContent = `${currentQuestionIndex + 1} из ${currentQuestions.length}`;
        document.getElementById('question-text').textContent = q.text;
        
        const progressPercent = ((currentQuestionIndex) / currentQuestions.length) * 100;
        document.getElementById('progress-fill').style.width = `${progressPercent}%`;
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';

        if (q.type === QuestionType.SingleChoice || q.type === QuestionType.MultipleChoice) {
            const inputType = q.type === QuestionType.SingleChoice ? 'radio' : 'checkbox';
            const indicatorClass = q.type === QuestionType.SingleChoice ? 'radio-indicator' : 'checkbox-indicator';

            q.options.forEach((opt, idx) => {
                const div = document.createElement('div');
                div.className = 'option-item';
                
                div.innerHTML = `
                    <div class="indicator ${indicatorClass}"></div>
                    <span style="flex:1;">${opt}</span>
                    <input type="${inputType}" name="opt" value="${idx + 1}">
                `;

                div.onclick = (e) => {
                    if (document.getElementById('submit-btn').style.display === 'none') return; // Locked

                    const inp = div.querySelector('input');
                    
                    if (inputType === 'radio') {
                        document.querySelectorAll('input[name="opt"]').forEach(i => {
                            i.checked = false;
                            i.closest('.option-item').classList.remove('selected');
                        });
                        inp.checked = true;
                        div.classList.add('selected');
                    } else {
                        // Prevent triggering twice if clicking directly on input/indicator (though they are pointer-events none mostly)
                        if (e.target !== inp) {
                            inp.checked = !inp.checked;
                        }
                        div.classList.toggle('selected', inp.checked);
                    }
                };
                container.appendChild(div);
            });
        } 
        else if (q.type === QuestionType.Sequence) {
            const ul = document.createElement('div');
            ul.id = 'sequence-list';
            ul.style.display = 'grid';
            ul.style.gap = '8px';
            
            q.options.forEach((opt) => {
                const li = document.createElement('div');
                li.className = 'sortable-item';
                li.draggable = true;
                li.innerHTML = `<span class="drag-handle">≡</span><span>${opt}</span>`;
                
                li.addEventListener('dragstart', () => li.classList.add('dragging'));
                li.addEventListener('dragend', () => li.classList.remove('dragging'));
                li.addEventListener('touchstart', (e) => handleTouchStart(e, li), {passive: false});
                li.addEventListener('touchmove', (e) => handleTouchMove(e, li), {passive: false});
                li.addEventListener('touchend', (e) => handleTouchEnd(e, li));

                ul.appendChild(li);
            });
            container.appendChild(ul);
            initSortable(ul);
        }
        else if (q.type === QuestionType.Matching) {
            Object.keys(q.matchingOptions).forEach(key => {
                const row = document.createElement('div');
                row.className = 'matching-row';
                
                const label = document.createElement('div');
                label.style.fontWeight = '600';
                label.textContent = `${key}. ${q.matchingOptions[key]}`;
                
                const select = document.createElement('select');
                select.className = 'matching-select';
                select.dataset.key = key;
                
                const defaultOpt = document.createElement('option');
                defaultOpt.text = "Выберите ответ...";
                defaultOpt.value = "";
                select.appendChild(defaultOpt);
                
                const values = Object.entries(q.matchingValues);
                values.sort(() => Math.random() - 0.5);
                
                values.forEach(([valKey, valText]) => {
                    const opt = document.createElement('option');
                    opt.value = valKey;
                    opt.text = valText;
                    select.appendChild(opt);
                });
                
                row.appendChild(label);
                row.appendChild(select);
                container.appendChild(row);
            });
        }

        document.getElementById('submit-btn').style.display = 'flex';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('detailed-feedback').style.display = 'none';
    }

    // -- Sortable Logic --
    function initSortable(list) {
        list.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(list, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (afterElement == null) {
                list.appendChild(draggable);
            } else {
                list.insertBefore(draggable, afterElement);
            }
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.sortable-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Touch Support
    let touchDragItem = null;
    function handleTouchStart(e, item) {
        touchDragItem = item;
        item.classList.add('dragging');
    }
    function handleTouchMove(e, item) {
        e.preventDefault();
        const touch = e.touches[0];
        const container = document.getElementById('sequence-list');
        const afterElement = getDragAfterElement(container, touch.clientY);
        if (afterElement == null) {
            container.appendChild(item);
        } else {
            container.insertBefore(item, afterElement);
        }
    }
    function handleTouchEnd(e, item) {
        item.classList.remove('dragging');
        touchDragItem = null;
    }

    function submitAnswer() {
        const q = currentQuestions[currentQuestionIndex];
        let isCorrect = false;
        let correctText = "";

        if (q.type === QuestionType.SingleChoice) {
            const selected = document.querySelector('input[name="opt"]:checked');
            if (!selected) {
                showFeedback('Выберите вариант ответа', false);
                return;
            }
            isCorrect = selected.value === q.correct;
            
            if(!isCorrect) {
                const correctIdx = parseInt(q.correct) - 1;
                correctText = q.options[correctIdx];
            }
        }
        else if (q.type === QuestionType.MultipleChoice) {
            const selected = Array.from(document.querySelectorAll('input[name="opt"]:checked'))
                .map(el => el.value)
                .sort((a,b) => a-b)
                .join(',');
            if (!selected) {
                showFeedback('Выберите варианты ответа', false);
                return;
            }
            isCorrect = selected === q.correct;
            
            if(!isCorrect) {
                const indices = q.correct.split(',');
                correctText = indices.map(i => q.options[parseInt(i)-1]).join(', ');
            }
        }
        else if (q.type === QuestionType.Sequence) {
            const originalQ = rawQuestions.find(rq => rq.id === q.id);
            const currentOrder = Array.from(document.querySelectorAll('.sortable-item')).map(el => el.querySelector('span:last-child').textContent);
            isCorrect = JSON.stringify(currentOrder) === JSON.stringify(originalQ.options);
            
            if(!isCorrect) correctText = originalQ.options.map((o,i) => `${i+1}. ${o}`).join('<br>');
        }
        else if (q.type === QuestionType.Matching) {
            const selects = document.querySelectorAll('.matching-select');
            let correctCount = 0;
            const pairs = q.correct.split(',').map(p => p.trim());
            const correctMap = {};
            pairs.forEach(p => {
                const [k, v] = p.split('-');
                correctMap[k] = v;
            });
            
            let allSelected = true;
            selects.forEach(sel => {
                if(!sel.value) allSelected = false;
                if(correctMap[sel.dataset.key] === sel.value) correctCount++;
            });
            
            if (!allSelected) {
                showFeedback('Заполните все поля', false);
                return;
            }

            isCorrect = correctCount === selects.length;
            if(!isCorrect) correctText = q.correct.replace(/,/g, '<br>');
        }

        if (isCorrect) score++;
        userAnswers.push({ q, isCorrect });

        showFeedback(isCorrect ? "Правильно!" : "Ошибка", isCorrect);
        
        if (!isCorrect) {
            const detailBox = document.getElementById('detailed-feedback');
            detailBox.innerHTML = `<strong>Правильный ответ:</strong><br>${correctText}`;
            detailBox.style.display = 'block';
        }

        document.getElementById('submit-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'flex';
        
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(i => i.disabled = true);
    }

    function showFeedback(text, isSuccess) {
        const popup = document.getElementById('feedback-popup');
        popup.textContent = text;
        popup.className = `feedback-popup ${isSuccess ? 'feedback-success' : 'feedback-error'} visible`;
        
        setTimeout(() => {
            popup.classList.remove('visible');
        }, 2000);
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentQuestions.length) {
            renderQuestion();
        } else {
            showResults();
        }
    }

    function showResults() {
        switchView('result-screen');
        const percent = Math.round((score / currentQuestions.length) * 100);
        
        const circle = document.getElementById('result-circle');
        circle.textContent = `${percent}%`;
        circle.className = `result-circle ${percent >= 90 ? 'result-good' : (percent >= 60 ? 'result-avg' : 'result-bad')}`;
        
        let msg = "";
        if (percent >= 90) msg = "Превосходный результат! 🎉";
        else if (percent >= 75) msg = "Хороший результат 👍";
        else if (percent >= 60) msg = "Неплохо, но есть пробелы";
        else msg = "Рекомендуется повторить материал";
        document.getElementById('final-message').textContent = msg;

        // Stats
        const stats = {};
        userAnswers.forEach(ans => {
            const t = ans.q.topic;
            if (!stats[t]) stats[t] = { total: 0, correct: 0 };
            stats[t].total++;
            if (ans.isCorrect) stats[t].correct++;
        });

        const statsContainer = document.getElementById('topic-stats-container');
        statsContainer.innerHTML = '';
        
        Object.keys(stats).forEach(topic => {
            const s = stats[topic];
            const p = Math.round((s.correct / s.total) * 100);
            const color = topicColors[topic];
            
            const div = document.createElement('div');
            div.className = 'stat-row';
            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div class="item-icon" style="background: ${color}; color:#000; width:28px; height:28px; font-size:14px; margin-right:12px; font-weight:700;">${topic.charAt(0)}</div>
                    <span style="font-size:15px; font-weight:500;">${topic}</span>
                </div>
                <span style="font-weight:700; color: ${p >= 60 ? 'var(--text-primary)' : 'var(--accent-red)'}">${s.correct}/${s.total}</span>
            `;
            statsContainer.appendChild(div);
        });
    }

</script>
</body>
</html>